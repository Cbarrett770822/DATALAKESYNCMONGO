<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DataLake Sync API Debug</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2, h3 {
      color: #1976d2;
    }
    button {
      background-color: #1976d2;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background-color: #1565c0;
    }
    pre {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow: auto;
      max-height: 500px;
      border: 1px solid #ddd;
    }
    .error {
      color: #d32f2f;
      background-color: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border: 1px solid #ffcdd2;
    }
    .success {
      color: #388e3c;
      background-color: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border: 1px solid #c8e6c9;
    }
    .info {
      color: #1976d2;
      background-color: #e3f2fd;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border: 1px solid #bbdefb;
    }
    .warning {
      color: #ff9800;
      background-color: #fff3e0;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border: 1px solid #ffe0b2;
    }
    .summary {
      margin: 10px 0;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
    }
    .container {
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <h1>DataLake Sync API Debug</h1>
  
  <div class="container">
    <h2>Debug Information</h2>
    <button id="getDebugInfo">Get Debug Info</button>
    <div id="debugResult"></div>
  </div>
  
  <div class="container">
    <h2>Test API Endpoints</h2>
    
    <h3>Submit Query</h3>
    <textarea id="sqlQuery" rows="4" style="width: 100%; margin-bottom: 10px;">SELECT * FROM "CSWMS_wmwhse_TASKDETAIL" LIMIT 1</textarea>
    <div style="margin-bottom: 10px;">
      <button id="resetQuery" style="background-color: #4caf50;">Reset to Working Query</button>
    </div>
    <button id="testSubmitQuery">Test Submit Query</button>
    <div id="submitQueryResult"></div>
    
    <h3>Check Status</h3>
    <input type="text" id="queryId" placeholder="Query ID">
    <button id="testCheckStatus">Test Check Status</button>
    <button id="testDirectStatus" style="background-color: #ff9800;">Direct Status (Debug)</button>
    <div id="checkStatusResult"></div>
    
    <h3>Get Results</h3>
    <input type="text" id="resultsQueryId" placeholder="Query ID">
    <button id="testGetResults">Test Get Results</button>
    <button id="testDirectResults" style="background-color: #ff9800;">Direct Results (Debug)</button>
    <div id="getResultsResult"></div>
  </div>
  
  <script>
    // Helper function to format JSON
    function formatJson(json) {
      return JSON.stringify(json, null, 2);
    }
    
    // Default working query - this format is confirmed to work with DataFabric
    const DEFAULT_WORKING_QUERY = 'SELECT * FROM "CSWMS_wmwhse_TASKDETAIL" LIMIT 1';
    
    // Helper function to display results
    function displayResult(elementId, data, isError = false) {
      const element = document.getElementById(elementId);
      
      if (isError) {
        element.innerHTML = `
          <div class="error">
            <strong>Error:</strong> ${data.message || 'Unknown error'}
          </div>
          <pre>${formatJson(data)}</pre>
        `;
      } else {
        element.innerHTML = `
          <div class="success">
            <strong>Success!</strong>
          </div>
          <pre>${formatJson(data)}</pre>
        `;
      }
    }
    
    // Get base URL
    const baseUrl = `${window.location.protocol}//${window.location.host}/.netlify/functions`;
    
    // Function to check query status
    async function checkQueryStatus(queryId) {
      try {
        if (!queryId) {
          console.error('No query ID provided');
          return;
        }
        
        // Show checking status message
        document.getElementById('checkStatusResult').innerHTML = `
          <div class="info">
            <strong>Checking status for query:</strong> ${queryId}...
          </div>
        `;
        
        console.log(`Checking status for query ID: ${queryId}`);
        const response = await fetch(`${baseUrl}/check-status?queryId=${queryId}`);
        const data = await response.json();
        console.log('Status check response:', data);
        
        if (response.ok) {
          // Update the status display
          let statusClass = 'info';
          let statusMessage = 'Query status: ' + data.status;
          
          if (data.status === 'COMPLETED' || data.status === 'FINISHED') {
            statusClass = 'success';
            statusMessage = 'Query completed successfully! Getting results...';
          } else if (data.status === 'FAILED') {
            statusClass = 'error';
            statusMessage = 'Query failed! See details below.';
          } else if (data.status === 'RUNNING') {
            statusMessage = 'Query is still running. Will check again in 2 seconds...';
          }
          
          document.getElementById('checkStatusResult').innerHTML = `
            <div class="${statusClass}">
              <strong>${statusMessage}</strong>
            </div>
            <pre>${formatJson(data)}</pre>
          `;
          
          // Handle next steps based on status
          // Convert status to uppercase for case-insensitive comparison
          const status = (data.status || '').toUpperCase();
          console.log(`Status check returned: "${status}" (original: "${data.status}")`);
          
          if (status === 'RUNNING') {
            console.log('Query still running, will check again in 2 seconds');
            setTimeout(() => checkQueryStatus(queryId), 2000);
          } else if (status === 'COMPLETED' || status === 'FINISHED' || status === 'DONE') {
            console.log(`Query ${status}, getting results now...`);
            // Add a small delay before getting results to ensure UI updates
            document.getElementById('getResultsResult').innerHTML = `
              <div class="info">
                <strong>Status is ${status}. Attempting to get results...</strong>
              </div>
            `;
            setTimeout(() => getQueryResults(queryId), 500);
          } else if (status === 'FAILED') {
            console.error('Query failed:', data);
          } else {
            console.warn('Unknown status:', status);
            // For any other status, we'll try to get results anyway
            console.log('Attempting to get results for unknown status...');
            document.getElementById('getResultsResult').innerHTML = `
              <div class="warning">
                <strong>Unknown status: ${status}. Attempting to get results anyway...</strong>
              </div>
            `;
            setTimeout(() => getQueryResults(queryId), 500);
          }
        } else {
          console.error('Error response from status check:', data);
          displayResult('checkStatusResult', data, true);
        }
      } catch (error) {
        console.error('Exception in checkQueryStatus:', error);
        displayResult('checkStatusResult', { message: error.message, stack: error.stack }, true);
      }
    }
    
    // Function to get query results
    async function getQueryResults(queryId) {
      try {
        if (!queryId) {
          console.error('No query ID provided');
          return;
        }
        
        // Show fetching results message
        document.getElementById('getResultsResult').innerHTML = `
          <div class="info">
            <strong>Fetching results for query:</strong> ${queryId}...
          </div>
        `;
        
        console.log(`Getting results for query ID: ${queryId}`);
        const response = await fetch(`${baseUrl}/get-results?queryId=${queryId}&offset=0&limit=100`);
        const data = await response.json();
        console.log('Results response:', data);
        
        if (response.ok) {
          // Format the results in a more readable way
          let formattedHtml = `
            <div class="success">
              <strong>Results retrieved successfully!</strong>
            </div>
          `;
          
          // Add summary information
          if (data.rows && data.rows.length > 0) {
            console.log(`Retrieved ${data.rows.length} rows of data`);
            formattedHtml += `
              <div class="summary">
                <p>Retrieved ${data.rows.length} rows</p>
              </div>
            `;
            
            // Add table view if there are rows and columns
            if (data.columns && data.columns.length > 0) {
              console.log(`Data has ${data.columns.length} columns`);
              formattedHtml += `
                <div class="table-container" style="overflow-x: auto; margin: 20px 0;">
                  <table style="border-collapse: collapse; width: 100%;">
                    <thead>
                      <tr>
                        ${data.columns.map(col => `<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">${col.name}</th>`).join('')}
                      </tr>
                    </thead>
                    <tbody>
                      ${data.rows.map(row => `
                        <tr>
                          ${Object.values(row).map(cell => `<td style="border: 1px solid #ddd; padding: 8px;">${cell !== null ? cell : 'NULL'}</td>`).join('')}
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `;
            } else {
              console.warn('Data has rows but no column definitions');
            }
          } else if (data.results && data.results.length > 0) {
            // Alternative format with results array
            console.log(`Retrieved ${data.results.length} results`);
            formattedHtml += `
              <div class="summary">
                <p>Retrieved ${data.results.length} results</p>
              </div>
              <div class="table-container" style="overflow-x: auto; margin: 20px 0;">
                <table style="border-collapse: collapse; width: 100%;">
                  <thead>
                    <tr>
                      ${Object.keys(data.results[0]).map(key => `<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">${key}</th>`).join('')}
                    </tr>
                  </thead>
                  <tbody>
                    ${data.results.map(item => `
                      <tr>
                        ${Object.values(item).map(cell => `<td style="border: 1px solid #ddd; padding: 8px;">${cell !== null ? cell : 'NULL'}</td>`).join('')}
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `;
          } else {
            console.warn('No rows or results found in the response');
            formattedHtml += `
              <div class="summary">
                <p>No rows returned by the query</p>
              </div>
            `;
          }
          
          // Add raw JSON data
          formattedHtml += `<pre>${formatJson(data)}</pre>`;
          
          document.getElementById('getResultsResult').innerHTML = formattedHtml;
        } else {
          console.error('Error response from get-results:', data);
          displayResult('getResultsResult', data, true);
        }
      } catch (error) {
        console.error('Exception in getQueryResults:', error);
        displayResult('getResultsResult', { message: error.message, stack: error.stack }, true);
      }
    }
    
    // Reset Query
    document.getElementById('resetQuery').addEventListener('click', () => {
      document.getElementById('sqlQuery').value = DEFAULT_WORKING_QUERY;
    });
    
    // Debug Info
    document.getElementById('getDebugInfo').addEventListener('click', async () => {
      try {
        const response = await fetch(`${baseUrl}/debug-info`);
        const data = await response.json();
        
        if (response.ok) {
          displayResult('debugResult', data);
        } else {
          displayResult('debugResult', data, true);
        }
      } catch (error) {
        displayResult('debugResult', { message: error.message, stack: error.stack }, true);
      }
    });
    
    // Submit Query
    document.getElementById('testSubmitQuery').addEventListener('click', async () => {
      try {
        const response = await fetch(`${baseUrl}/submit-query`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sqlQuery: document.getElementById('sqlQuery').value
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          displayResult('submitQueryResult', data);
          // Auto-fill query ID fields
          if (data.queryId) {
            document.getElementById('queryId').value = data.queryId;
            document.getElementById('resultsQueryId').value = data.queryId;
            
            // Auto-check status after 1 second
            setTimeout(() => {
              console.log('Auto-checking status for query:', data.queryId);
              checkQueryStatus(data.queryId);
            }, 1000);
          }
        } else {
          displayResult('submitQueryResult', data, true);
        }
      } catch (error) {
        displayResult('submitQueryResult', { message: error.message, stack: error.stack }, true);
      }
    });
    
    // Check Status
    document.getElementById('testCheckStatus').addEventListener('click', async () => {
      try {
        const queryId = document.getElementById('queryId').value;
        
        if (!queryId) {
          displayResult('checkStatusResult', { message: 'Query ID is required' }, true);
          return;
        }
        
        const response = await fetch(`${baseUrl}/check-status?queryId=${queryId}`);
        const data = await response.json();
        
        if (response.ok) {
          displayResult('checkStatusResult', data);
          
          // If query is completed, automatically populate the results query ID
          if (data.status === 'COMPLETED' || data.status === 'FINISHED' || data.status === 'finished' || data.status === 'completed') {
            document.getElementById('resultsQueryId').value = queryId;
          }
        } else {
          displayResult('checkStatusResult', data, true);
        }
      } catch (error) {
        displayResult('checkStatusResult', { message: error.message, stack: error.stack }, true);
      }
    });
    
    // Get Results
    document.getElementById('testGetResults').addEventListener('click', async () => {
      try {
        const queryId = document.getElementById('resultsQueryId').value;
        
        if (!queryId) {
          displayResult('getResultsResult', { message: 'Query ID is required' }, true);
          return;
        }
        
        const response = await fetch(`${baseUrl}/get-results?queryId=${queryId}&offset=0&limit=10`);
        const data = await response.json();
        
        if (response.ok) {
          displayResult('getResultsResult', data);
        } else {
          displayResult('getResultsResult', data, true);
        }
      } catch (error) {
        displayResult('getResultsResult', { message: error.message, stack: error.stack }, true);
      }
    });
    
    // Direct Status Check (Debug)
    document.getElementById('testDirectStatus').addEventListener('click', async () => {
      try {
        const queryId = document.getElementById('queryId').value;
        
        if (!queryId) {
          displayResult('checkStatusResult', { message: 'Query ID is required' }, true);
          return;
        }
        
        document.getElementById('checkStatusResult').innerHTML = `
          <div class="info">
            <strong>Performing direct status check for query:</strong> ${queryId}...
            <p>This will make a direct API call to the DataFabric API.</p>
          </div>
        `;
        
        // Add debug parameter to trigger direct status check
        const response = await fetch(`${baseUrl}/check-status?queryId=${queryId}&debug=true`);
        const data = await response.json();
        
        if (response.ok) {
          // Convert status to uppercase for display
          const status = (data.status || '').toUpperCase();
          const statusClass = 
            (status === 'COMPLETED' || status === 'FINISHED' || status === 'DONE') ? 'success' : 
            (status === 'FAILED') ? 'error' : 
            (status === 'RUNNING') ? 'info' : 'warning';
          
          let formattedHtml = `
            <div class="${statusClass}">
              <strong>Direct status check result: ${status}</strong>
            </div>
            <div class="summary">
              <p>Raw status value: "${data.status}"</p>
              <p>Progress: ${data.progress || 0}%</p>
            </div>
          `;
          
          // If status indicates completion, automatically populate the results query ID
          if (status === 'COMPLETED' || status === 'FINISHED' || status === 'DONE') {
            document.getElementById('resultsQueryId').value = queryId;
            formattedHtml += `
              <div class="info">
                <p>Status indicates completion. The query ID has been copied to the Get Results section.</p>
                <button id="getResultsNow" class="btn" style="background-color: #4caf50; color: white; padding: 8px 16px; border: none; cursor: pointer; margin-top: 10px;">Get Results Now</button>
              </div>
            `;
          }
          
          // Add raw JSON data
          formattedHtml += `<pre>${formatJson(data)}</pre>`;
          
          document.getElementById('checkStatusResult').innerHTML = formattedHtml;
          
          // Add event listener for the Get Results Now button if it exists
          const getResultsNowButton = document.getElementById('getResultsNow');
          if (getResultsNowButton) {
            getResultsNowButton.addEventListener('click', () => {
              document.getElementById('testDirectResults').click();
            });
          }
        } else {
          displayResult('checkStatusResult', data, true);
        }
      } catch (error) {
        displayResult('checkStatusResult', { message: error.message, stack: error.stack }, true);
      }
    });
    
    // Direct Results (Debug)
    document.getElementById('testDirectResults').addEventListener('click', async () => {
      try {
        const queryId = document.getElementById('resultsQueryId').value;
        
        if (!queryId) {
          displayResult('getResultsResult', { message: 'Query ID is required' }, true);
          return;
        }
        
        document.getElementById('getResultsResult').innerHTML = `
          <div class="info">
            <strong>Fetching direct results for query:</strong> ${queryId}...
            <p>This bypasses status checks and directly calls the API endpoint.</p>
          </div>
        `;
        
        // Add debug parameter to trigger direct fetch
        const response = await fetch(`${baseUrl}/get-results?queryId=${queryId}&offset=0&limit=10&debug=true`);
        const data = await response.json();
        
        if (response.ok) {
          let formattedHtml = `
            <div class="success">
              <strong>Direct results retrieved!</strong>
            </div>
            <div class="summary">
              <p>Direct API call completed. Check Netlify logs for details.</p>
            </div>
          `;
          
          // Add raw JSON data
          formattedHtml += `<pre>${formatJson(data)}</pre>`;
          
          document.getElementById('getResultsResult').innerHTML = formattedHtml;
        } else {
          displayResult('getResultsResult', data, true);
        }
      } catch (error) {
        displayResult('getResultsResult', { message: error.message, stack: error.stack }, true);
      }
    });
  </script>
</body>
</html>
